<?xml version="1.0" encoding="UTF-8"?>
<form name="frmMob"
      formType="sheetTemplate"
      dataType="br.com.mineBR55.mob"
      title="Ficha Mob">

  <script><![CDATA[
    require("firecast.lua");
    require("ndb.lua");
    
    local function num(v)
      local n = tonumber(v)
      return n or 0
    end

    local function isChecked(v)
      return (v == true) or (v == "true") or (v == 1)
    end

    local function mod(score)
      return math.floor((num(score) - 10) / 2)
    end

    local function signed(n)
      n = num(n)
      if n >= 0 then return "+" .. tostring(n) else return tostring(n) end
    end

    local function clamp(n, a, b)
      if n < a then return a end
      if n > b then return b end
      return n
    end

    function buildD20(bonus)
      bonus = num(bonus)
      if bonus >= 0 then
        return "1d20 + " .. tostring(bonus)
      else
        return "1d20 - " .. tostring(math.abs(bonus))
      end
    end

    function rollBonus(title, bonus)
      local mesa = Firecast.getMesaDe(sheet)
      if mesa ~= nil then
        mesa.chat:rolarDados(Firecast.interpretarRolagem(buildD20(bonus)), title)
      end
    end

    -- Proficiência com expertise:
    -- Exp marcada => +pb*2
    -- Senão Prof marcada => +pb
    function profBonus(profField, expField)
      local pb = num(sheet.prof_bonus_num)
      if isChecked(sheet[expField]) then return pb * 2 end
      if isChecked(sheet[profField]) then return pb end
      return 0
    end

    function resolveExpr(expr)
      expr = tostring(expr or "")
      local pb = num(sheet.prof_bonus_num)

      local map = {
        ["STR"] = num(sheet.mod_forca_num),
        ["DEX"] = num(sheet.mod_destreza_num),
        ["CON"] = num(sheet.mod_constituicao_num),
        ["INT"] = num(sheet.mod_inteligencia_num),
        ["WIS"] = num(sheet.mod_sabedoria_num),
        ["CHA"] = num(sheet.mod_carisma_num),
        ["PB"]  = pb
      }

      for k, v in pairs(map) do
        expr = expr:gsub("%f[%w_]" .. k .. "%f[^%w_]", tostring(v))
      end

      return expr
    end

    function rollExpr(title, expr)
      local mesa = Firecast.getMesaDe(sheet)
      if mesa ~= nil then
        local resolved = resolveExpr(expr)
        mesa.chat:rolarDados(Firecast.interpretarRolagem(resolved), title .. " (" .. resolved .. ")")
      end
    end
    function recalcAll()
  sheet.forca = sheet.forca
  sheet.destreza = sheet.destreza
  sheet.constituicao = sheet.constituicao
  sheet.inteligencia = sheet.inteligencia
  sheet.sabedoria = sheet.sabedoria
  sheet.carisma = sheet.carisma

  sheet.hp_atual = sheet.hp_atual
end
    _G.__num = num
    _G.__mod = mod
    _G.__signed = signed
    _G.__profBonus = profBonus
    _G.__clamp = clamp

  ]]></script>

  <tabControl align="client">

    <!-- ===================== ABA FRENTE ===================== -->
    <tab text="Frente">
      <scrollBox align="client">
        <layout align="top" height="2800">

          <!-- fundo -->
          <layout align="top" height="2800">
            <image align="client" src="images/bg.png" style="autoFit"/>
            <image align="client" src="images/panel.png" style="autoFit"/>

            <layout align="client">

              <!-- ===== CAIXA: IDENTIDADE ===== -->
<layout align="top" height="130">
  <!-- fundo da caixinha (enabled=false pra NÃO bloquear cliques) -->
  <rectangle align="client" color="#000000" opacity="0.22" xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="10"/>

    <layout align="top" height="20">
      <label left="14" top="0" width="200" height="20"
             text="IDENTIDADE" fontColor="#EDEDED" fontSize="14"/>
    </layout>

    <layout align="top" height="8"/>

    <!-- Linha 1: Nome + Tipo -->
    <layout align="top" height="30">
      <label left="14" top="6" width="60" height="20" text="Nome" fontColor="#CCCCCC"/>
      <edit  left="70" top="3" width="360" height="24" field="nome" fontColor="#FFFFFF"/>

      <label left="445" top="6" width="45" height="20" text="Tipo" fontColor="#CCCCCC"/>
      <edit  left="485" top="3" width="250" height="24" field="tipo" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 2: Tamanho + Alinhamento -->
    <layout align="top" height="30">
      <label left="14" top="6" width="70" height="20" text="Tamanho" fontColor="#CCCCCC"/>
      <edit  left="80" top="3" width="160" height="24" field="tamanho" fontColor="#FFFFFF"/>

      <label left="260" top="6" width="90" height="20" text="Alinh." fontColor="#CCCCCC"/>
      <edit  left="310" top="3" width="220" height="24" field="alinhamento" fontColor="#FFFFFF"/>
    </layout>
  </layout>
</layout>

<layout align="top" height="12"/>

              <!-- ===== MOVIMENTAÇÃO + SENTIDOS (LABEL EM CIMA + GRID) ===== -->
              <!-- ===== CAIXA: MOVIMENTAÇÃO ===== -->
<layout align="top" height="135">
  <rectangle align="client" color="#000000" opacity="0.22"
             xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="10"/>

    <layout align="top" height="20">
      <label left="14" top="0" width="220" height="20"
             text="MOVIMENTAÇÃO" fontColor="#EDEDED" fontSize="14"/>
    </layout>

    <layout align="top" height="10"/>

    <!-- Linha 1 -->
    <layout align="top" height="30">
      <label left="14" top="6" width="45" height="20" text="Walk" fontColor="#CCCCCC"/>
      <edit  left="58" top="3" width="60" height="24" field="mov_walk"
             horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="120" top="6" width="18" height="20" text="m" fontColor="#888888"/>

      <label left="150" top="6" width="50" height="20" text="Climb" fontColor="#CCCCCC"/>
      <edit  left="198" top="3" width="60" height="24" field="mov_climb"
             horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="260" top="6" width="18" height="20" text="m" fontColor="#888888"/>

      <label left="290" top="6" width="35" height="20" text="Fly" fontColor="#CCCCCC"/>
      <edit  left="320" top="3" width="60" height="24" field="mov_fly"
             horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="382" top="6" width="18" height="20" text="m" fontColor="#888888"/>
    </layout>

    <!-- Linha 2 -->
    <layout align="top" height="30">
      <label left="14" top="6" width="45" height="20" text="Swim" fontColor="#CCCCCC"/>
      <edit  left="58" top="3" width="60" height="24" field="mov_swim"
             horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="120" top="6" width="18" height="20" text="m" fontColor="#888888"/>

      <label left="150" top="6" width="55" height="20" text="Burrow" fontColor="#CCCCCC"/>
      <edit  left="205" top="3" width="60" height="24" field="mov_burrow"
             horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="267" top="6" width="18" height="20" text="m" fontColor="#888888"/>
    </layout>

  </layout>
</layout>

<layout align="top" height="12"/>
<!-- ===== CAIXA: SENTIDOS ===== -->
<layout align="top" height="150">
  <rectangle align="client" color="#000000" opacity="0.22"
             xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="10"/>

    <layout align="top" height="20">
      <label left="14" top="0" width="220" height="20"
             text="SENTIDOS" fontColor="#EDEDED" fontSize="14"/>
    </layout>

    <layout align="top" height="10"/>

    <!-- Linha 1 -->
    <layout align="top" height="30">
      <label left="14" top="6" width="70" text="Blindsight" fontColor="#CCCCCC"/>
      <edit  left="80" top="3" width="60" height="24"
             field="sen_blind" horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="142" top="6" width="18" text="m" fontColor="#888888"/>

      <label left="170" top="6" width="75" text="Darkvision" fontColor="#CCCCCC"/>
      <edit  left="240" top="3" width="60" height="24"
             field="sen_dark" horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="302" top="6" width="18" text="m" fontColor="#888888"/>
    </layout>

    <!-- Linha 2 -->
    <layout align="top" height="30">
      <label left="14" top="6" width="85" text="Tremorsense" fontColor="#CCCCCC"/>
      <edit  left="95" top="3" width="60" height="24"
             field="sen_tremor" horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="157" top="6" width="18" text="m" fontColor="#888888"/>

      <label left="185" top="6" width="70" text="Truesight" fontColor="#CCCCCC"/>
      <edit  left="250" top="3" width="60" height="24"
             field="sen_true" horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="312" top="6" width="18" text="m" fontColor="#888888"/>
    </layout>

    <layout align="top" height="10"/>

    <!-- Percepção Passiva -->
    <layout align="top" height="30">
      <label left="14" top="6" width="140"
             text="Percepção Passiva" fontColor="#CCCCCC"/>
      <edit  left="150" top="3" width="70" height="24"
             field="percepcao_passiva"
             horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

  </layout>
</layout>

<layout align="top" height="12"/>

            <!-- ===== CAIXA: DEFESAS ===== -->
<layout align="top" height="150">
  <rectangle align="client" color="#000000" opacity="0.22"
             xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="10"/>

    <layout align="top" height="20">
      <label left="14" top="0" width="200" height="20"
             text="DEFESAS" fontColor="#EDEDED" fontSize="14"/>
    </layout>

    <layout align="top" height="12"/>

    <!-- Linha principal -->
    <layout align="top" height="30">
      <label left="14" top="6" width="30" text="CA" fontColor="#CCCCCC"/>
      <edit  left="45" top="3" width="60" height="24"
             field="ca" horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="130" top="6" width="70" text="HP Atual" fontColor="#CCCCCC"/>
      <edit  left="200" top="3" width="90" height="24"
             field="hp_atual" horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="310" top="6" width="70" text="HP Máx" fontColor="#CCCCCC"/>
      <edit  left="380" top="3" width="90" height="24"
             field="hp_max" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <layout align="top" height="15"/>

   <!-- Barra de Vida -->
<layout align="top" height="45">
  <label left="14" top="0" width="200" height="18"
         text="Barra de Vida" fontColor="#CCCCCC"/>

  <progressBar left="14" top="20" width="520" height="18"
               field="hp_atual"
               fieldMax="hp_max"/>
</layout>
  </layout>
</layout>

<layout align="top" height="12"/>

<!-- ===== ATRIBUTOS + SAVES + SKILLS (POR ATRIBUTO) ===== -->
<layout align="top" height="12"/>

<layout align="top" height="26">
  <label align="client" text="ATRIBUTOS / SAVES / SKILLS" fontColor="#EDEDED" fontSize="14"/>
</layout>

<layout align="top" height="10"/>

<!-- ===================== FORÇA ===================== -->
<layout align="top" height="110">
  <rectangle align="client" color="#000000" opacity="0.22" xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="8"/>

    <!-- Linha 1: atributo + save -->
    <layout align="top" height="28">
      <!-- Atributo (botão) -->
      <button left="10" top="2" width="120" height="24" text="FORÇA (STR)">
        <event name="onClick"><![CDATA[
          rollBonus("STR", sheet.mod_forca_num);
        ]]></event>
      </button>

      <label left="135" top="6" width="30" text="Val" fontColor="#999999"/>
      <edit  left="165" top="2" width="55" height="24" field="forca" type="number"
             horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="225" top="6" width="30" text="Mod" fontColor="#999999"/>
      <edit  left="255" top="2" width="55" height="24" field="mod_forca"
             readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <!-- Save (botão) -->
      <button left="325" top="2" width="80" height="24" text="Save">
        <event name="onClick"><![CDATA[
          rollBonus("STR Save", sheet.sv_str_total_num);
        ]]></event>
      </button>

      <checkBox left="410" top="6" width="18" field="sv_str_prof" text=""/>
      <checkBox left="432" top="6" width="18" field="sv_str_exp" text=""/>
      <edit     left="455" top="2" width="45" height="24" field="sv_str_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="505" top="2" width="55" height="24" field="sv_str_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 2: skill Athletics -->
    <layout align="top" height="28">
      <button left="10" top="2" width="140" height="24" text="Athletics">
        <event name="onClick"><![CDATA[
          rollBonus("Athletics", sheet.sk_athletics_total_num);
        ]]></event>
      </button>

      <checkBox left="155" top="6" width="18" field="sk_athletics_prof" text=""/>
      <checkBox left="177" top="6" width="18" field="sk_athletics_exp" text=""/>
      <edit     left="200" top="2" width="45" height="24" field="sk_athletics_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="250" top="2" width="55" height="24" field="sk_athletics_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <layout align="top" height="8"/>
  </layout>
</layout>

<layout align="top" height="10"/>

<!-- ===================== DESTREZA ===================== -->
<layout align="top" height="165">
  <rectangle align="client" color="#000000" opacity="0.22" xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="8"/>

    <!-- Linha 1: atributo + save -->
    <layout align="top" height="28">
      <!-- Atributo (botão) -->
      <button left="10" top="2" width="140" height="24" text="DESTREZA (DEX)">
        <event name="onClick"><![CDATA[
          rollBonus("DEX", sheet.mod_destreza_num);
        ]]></event>
      </button>

      <label left="155" top="6" width="30" text="Val" fontColor="#999999"/>
      <edit  left="185" top="2" width="55" height="24" field="destreza" type="number"
             horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="245" top="6" width="30" text="Mod" fontColor="#999999"/>
      <edit  left="275" top="2" width="55" height="24" field="mod_destreza"
             readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <!-- Save (botão) -->
      <button left="345" top="2" width="80" height="24" text="Save">
        <event name="onClick"><![CDATA[
          rollBonus("DEX Save", sheet.sv_dex_total_num);
        ]]></event>
      </button>

      <checkBox left="430" top="6" width="18" field="sv_dex_prof" text=""/>
      <checkBox left="452" top="6" width="18" field="sv_dex_exp" text=""/>
      <edit     left="475" top="2" width="45" height="24" field="sv_dex_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="525" top="2" width="55" height="24" field="sv_dex_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 2: Initiative -->
    <layout align="top" height="28">
      <button left="10" top="2" width="140" height="24" text="Initiative">
        <event name="onClick"><![CDATA[
          rollBonus("Initiative", sheet.sk_initiative_total_num);
        ]]></event>
      </button>

      <checkBox left="155" top="6" width="18" field="sk_initiative_prof" text=""/>
      <checkBox left="177" top="6" width="18" field="sk_initiative_exp" text=""/>
      <edit     left="200" top="2" width="45" height="24" field="sk_initiative_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="250" top="2" width="55" height="24" field="sk_initiative_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 3: Acrobatics + Sleight of Hand -->
    <layout align="top" height="28">
      <button left="10" top="2" width="140" height="24" text="Acrobatics">
        <event name="onClick"><![CDATA[
          rollBonus("Acrobatics", sheet.sk_acrobatics_total_num);
        ]]></event>
      </button>

      <checkBox left="155" top="6" width="18" field="sk_acrobatics_prof" text=""/>
      <checkBox left="177" top="6" width="18" field="sk_acrobatics_exp" text=""/>
      <edit     left="200" top="2" width="45" height="24" field="sk_acrobatics_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="250" top="2" width="55" height="24" field="sk_acrobatics_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="325" top="2" width="170" height="24" text="Sleight of Hand">
        <event name="onClick"><![CDATA[
          rollBonus("Sleight of Hand", sheet.sk_sleight_total_num);
        ]]></event>
      </button>

      <checkBox left="500" top="6" width="18" field="sk_sleight_prof" text=""/>
      <checkBox left="522" top="6" width="18" field="sk_sleight_exp" text=""/>
      <edit     left="545" top="2" width="45" height="24" field="sk_sleight_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="595" top="2" width="55" height="24" field="sk_sleight_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 4: Stealth -->
    <layout align="top" height="28">
      <button left="10" top="2" width="140" height="24" text="Stealth">
        <event name="onClick"><![CDATA[
          rollBonus("Stealth", sheet.sk_stealth_total_num);
        ]]></event>
      </button>

      <checkBox left="155" top="6" width="18" field="sk_stealth_prof" text=""/>
      <checkBox left="177" top="6" width="18" field="sk_stealth_exp" text=""/>
      <edit     left="200" top="2" width="45" height="24" field="sk_stealth_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="250" top="2" width="55" height="24" field="sk_stealth_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <layout align="top" height="8"/>
  </layout>
</layout>

<layout align="top" height="10"/>

<!-- ===================== CONSTITUIÇÃO ===================== -->
<layout align="top" height="95">
  <rectangle align="client" color="#000000" opacity="0.22" xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="8"/>

    <!-- Linha 1: atributo + save -->
    <layout align="top" height="28">
      <!-- Atributo (botão) -->
      <button left="10" top="2" width="170" height="24" text="CONSTITUIÇÃO (CON)">
        <event name="onClick"><![CDATA[
          rollBonus("CON", sheet.mod_constituicao_num);
        ]]></event>
      </button>

      <label left="185" top="6" width="30" text="Val" fontColor="#999999"/>
      <edit  left="215" top="2" width="55" height="24" field="constituicao" type="number"
             horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="275" top="6" width="30" text="Mod" fontColor="#999999"/>
      <edit  left="305" top="2" width="55" height="24" field="mod_constituicao"
             readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <!-- Save (botão) -->
      <button left="375" top="2" width="80" height="24" text="Save">
        <event name="onClick"><![CDATA[
          rollBonus("CON Save", sheet.sv_con_total_num);
        ]]></event>
      </button>

      <checkBox left="460" top="6" width="18" field="sv_con_prof" text=""/>
      <checkBox left="482" top="6" width="18" field="sv_con_exp" text=""/>
      <edit     left="505" top="2" width="45" height="24" field="sv_con_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="555" top="2" width="55" height="24" field="sv_con_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <layout align="top" height="8"/>
  </layout>
</layout>

<layout align="top" height="10"/>

<!-- ===================== INTELIGÊNCIA ===================== -->
<layout align="top" height="185">
  <rectangle align="client" color="#000000" opacity="0.22" xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="8"/>

    <!-- Linha 1: atributo + save -->
    <layout align="top" height="28">
      <button left="10" top="2" width="170" height="24" text="INTELIGÊNCIA (INT)">
        <event name="onClick"><![CDATA[
          rollBonus("INT", sheet.mod_inteligencia_num);
        ]]></event>
      </button>

      <label left="185" top="6" width="30" text="Val" fontColor="#999999"/>
      <edit  left="215" top="2" width="55" height="24" field="inteligencia" type="number"
             horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="275" top="6" width="30" text="Mod" fontColor="#999999"/>
      <edit  left="305" top="2" width="55" height="24" field="mod_inteligencia"
             readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="375" top="2" width="80" height="24" text="Save">
        <event name="onClick"><![CDATA[
          rollBonus("INT Save", sheet.sv_int_total_num);
        ]]></event>
      </button>

      <checkBox left="460" top="6" width="18" field="sv_int_prof" text=""/>
      <checkBox left="482" top="6" width="18" field="sv_int_exp" text=""/>
      <edit     left="505" top="2" width="45" height="24" field="sv_int_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="555" top="2" width="55" height="24" field="sv_int_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 2: Arcana + History -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Arcana">
        <event name="onClick"><![CDATA[
          rollBonus("Arcana", sheet.sk_arcana_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_arcana_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_arcana_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_arcana_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_arcana_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="335" top="2" width="160" height="24" text="History">
        <event name="onClick"><![CDATA[
          rollBonus("History", sheet.sk_history_total_num);
        ]]></event>
      </button>
      <checkBox left="500" top="6" width="18" field="sk_history_prof" text=""/>
      <checkBox left="522" top="6" width="18" field="sk_history_exp" text=""/>
      <edit     left="545" top="2" width="45" height="24" field="sk_history_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="595" top="2" width="55" height="24" field="sk_history_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 3: Investigation + Nature -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Investigation">
        <event name="onClick"><![CDATA[
          rollBonus("Investigation", sheet.sk_investigation_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_investigation_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_investigation_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_investigation_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_investigation_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="335" top="2" width="160" height="24" text="Nature">
        <event name="onClick"><![CDATA[
          rollBonus("Nature", sheet.sk_nature_total_num);
        ]]></event>
      </button>
      <checkBox left="500" top="6" width="18" field="sk_nature_prof" text=""/>
      <checkBox left="522" top="6" width="18" field="sk_nature_exp" text=""/>
      <edit     left="545" top="2" width="45" height="24" field="sk_nature_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="595" top="2" width="55" height="24" field="sk_nature_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 4: Religion -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Religion">
        <event name="onClick"><![CDATA[
          rollBonus("Religion", sheet.sk_religion_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_religion_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_religion_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_religion_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_religion_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <layout align="top" height="8"/>
  </layout>
</layout>

<layout align="top" height="10"/>

<!-- ===================== SABEDORIA ===================== -->
<layout align="top" height="210">
  <rectangle align="client" color="#000000" opacity="0.22" xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="8"/>

    <!-- Linha 1: atributo + save -->
    <layout align="top" height="28">
      <button left="10" top="2" width="170" height="24" text="SABEDORIA (WIS)">
        <event name="onClick"><![CDATA[
          rollBonus("WIS", sheet.mod_sabedoria_num);
        ]]></event>
      </button>

      <label left="185" top="6" width="30" text="Val" fontColor="#999999"/>
      <edit  left="215" top="2" width="55" height="24" field="sabedoria" type="number"
             horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="275" top="6" width="30" text="Mod" fontColor="#999999"/>
      <edit  left="305" top="2" width="55" height="24" field="mod_sabedoria"
             readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="375" top="2" width="80" height="24" text="Save">
        <event name="onClick"><![CDATA[
          rollBonus("WIS Save", sheet.sv_wis_total_num);
        ]]></event>
      </button>

      <checkBox left="460" top="6" width="18" field="sv_wis_prof" text=""/>
      <checkBox left="482" top="6" width="18" field="sv_wis_exp" text=""/>
      <edit     left="505" top="2" width="45" height="24" field="sv_wis_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="555" top="2" width="55" height="24" field="sv_wis_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 2: Animal Handling + Insight -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Animal Handling">
        <event name="onClick"><![CDATA[
          rollBonus("Animal Handling", sheet.sk_animal_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_animal_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_animal_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_animal_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_animal_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="335" top="2" width="160" height="24" text="Insight">
        <event name="onClick"><![CDATA[
          rollBonus("Insight", sheet.sk_insight_total_num);
        ]]></event>
      </button>
      <checkBox left="500" top="6" width="18" field="sk_insight_prof" text=""/>
      <checkBox left="522" top="6" width="18" field="sk_insight_exp" text=""/>
      <edit     left="545" top="2" width="45" height="24" field="sk_insight_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="595" top="2" width="55" height="24" field="sk_insight_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 3: Medicine + Perception -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Medicine">
        <event name="onClick"><![CDATA[
          rollBonus("Medicine", sheet.sk_medicine_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_medicine_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_medicine_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_medicine_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_medicine_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="335" top="2" width="160" height="24" text="Perception">
        <event name="onClick"><![CDATA[
          rollBonus("Perception", sheet.sk_perception_total_num);
        ]]></event>
      </button>
      <checkBox left="500" top="6" width="18" field="sk_perception_prof" text=""/>
      <checkBox left="522" top="6" width="18" field="sk_perception_exp" text=""/>
      <edit     left="545" top="2" width="45" height="24" field="sk_perception_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="595" top="2" width="55" height="24" field="sk_perception_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 4: Survival -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Survival">
        <event name="onClick"><![CDATA[
          rollBonus("Survival", sheet.sk_survival_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_survival_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_survival_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_survival_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_survival_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <layout align="top" height="8"/>
  </layout>
</layout>

<layout align="top" height="10"/>

<!-- ===================== CARISMA ===================== -->
<layout align="top" height="185">
  <rectangle align="client" color="#000000" opacity="0.22" xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="8"/>

    <!-- Linha 1: atributo + save -->
    <layout align="top" height="28">
      <button left="10" top="2" width="170" height="24" text="CARISMA (CHA)">
        <event name="onClick"><![CDATA[
          rollBonus("CHA", sheet.mod_carisma_num);
        ]]></event>
      </button>

      <label left="185" top="6" width="30" text="Val" fontColor="#999999"/>
      <edit  left="215" top="2" width="55" height="24" field="carisma" type="number"
             horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="275" top="6" width="30" text="Mod" fontColor="#999999"/>
      <edit  left="305" top="2" width="55" height="24" field="mod_carisma"
             readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="375" top="2" width="80" height="24" text="Save">
        <event name="onClick"><![CDATA[
          rollBonus("CHA Save", sheet.sv_cha_total_num);
        ]]></event>
      </button>

      <checkBox left="460" top="6" width="18" field="sv_cha_prof" text=""/>
      <checkBox left="482" top="6" width="18" field="sv_cha_exp" text=""/>
      <edit     left="505" top="2" width="45" height="24" field="sv_cha_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="555" top="2" width="55" height="24" field="sv_cha_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 2: Deception + Intimidation -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Deception">
        <event name="onClick"><![CDATA[
          rollBonus("Deception", sheet.sk_deception_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_deception_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_deception_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_deception_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_deception_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="335" top="2" width="160" height="24" text="Intimidation">
        <event name="onClick"><![CDATA[
          rollBonus("Intimidation", sheet.sk_intimidation_total_num);
        ]]></event>
      </button>
      <checkBox left="500" top="6" width="18" field="sk_intimidation_prof" text=""/>
      <checkBox left="522" top="6" width="18" field="sk_intimidation_exp" text=""/>
      <edit     left="545" top="2" width="45" height="24" field="sk_intimidation_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="595" top="2" width="55" height="24" field="sk_intimidation_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 3: Performance + Persuasion -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Performance">
        <event name="onClick"><![CDATA[
          rollBonus("Performance", sheet.sk_performance_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_performance_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_performance_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_performance_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_performance_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="335" top="2" width="160" height="24" text="Persuasion">
        <event name="onClick"><![CDATA[
          rollBonus("Persuasion", sheet.sk_persuasion_total_num);
        ]]></event>
      </button>
      <checkBox left="500" top="6" width="18" field="sk_persuasion_prof" text=""/>
      <checkBox left="522" top="6" width="18" field="sk_persuasion_exp" text=""/>
      <edit     left="545" top="2" width="45" height="24" field="sk_persuasion_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="595" top="2" width="55" height="24" field="sk_persuasion_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <layout align="top" height="8"/>
  </layout>
</layout>

<layout align="top" height="10"/>
              
              <!-- ===================== CÁLCULOS ===================== -->

              <!-- CR -> PB (tabela oficial 5e) -->
<dataLink field="cr">
  <event name="onChange"><![CDATA[
    local function parseCR(cr)
      local s = tostring(cr or ""):gsub("%s+","")
      if s == "" then return 0 end
      if s == "1/8" then return 0.125 end
      if s == "1/4" then return 0.25 end
      if s == "1/2" then return 0.5 end
      local n = tonumber(s); if n ~= nil then return n end
      return 0
    end

    local function pbFromCR(crVal)
      -- 5e: CR 0–4 => +2; 5–8 => +3; 9–12 => +4; 13–16 => +5; 17–20 => +6; 21–24 => +7; 25–28 => +8; 29–30 => +9
      if crVal < 5 then return 2 end
      if crVal < 9 then return 3 end
      if crVal < 13 then return 4 end
      if crVal < 17 then return 5 end
      if crVal < 21 then return 6 end
      if crVal < 25 then return 7 end
      if crVal < 29 then return 8 end
      return 9
    end

    local crVal = parseCR(sheet.cr)
    local pb = pbFromCR(crVal)

    sheet.prof_bonus_num = pb
    sheet.prof_bonus = __signed(pb)

    -- força recálculo de tudo que depende do PB
    if recalcAll ~= nil then
      recalcAll()
    else
      sheet.forca = sheet.forca
      sheet.destreza = sheet.destreza
      sheet.constituicao = sheet.constituicao
      sheet.inteligencia = sheet.inteligencia
      sheet.sabedoria = sheet.sabedoria
      sheet.carisma = sheet.carisma
    end
  ]]></event>
</dataLink>

              <!-- Vida % -->
              <dataLink field="hp_max"><event name="onChange"><![CDATA[ sheet.hp_atual = sheet.hp_atual ]]></event></dataLink>
              <dataLink field="hp_atual">
                <event name="onChange"><![CDATA[
                  local maxv = __num(sheet.hp_max)
                  local curv = __num(sheet.hp_atual)

                  if maxv <= 0 then
                    sheet.hp_pct = 0
                    sheet.hp_pct_txt = "0"
                    return
                  end

                  local pct = math.floor((curv / maxv) * 100 + 0.5)
                  if pct < 0 then pct = 0 end
                  if pct > 100 then pct = 100 end

                  sheet.hp_pct = pct
                  sheet.hp_pct_txt = tostring(pct)
                ]]></event>
              </dataLink>

              <!-- STR -->
              <dataLink field="forca">
                <event name="onChange"><![CDATA[
                  local m = __mod(sheet.forca)
                  sheet.mod_forca_num = m
                  sheet.mod_forca = __signed(m)

                  local sv = m + __profBonus("sv_str_prof","sv_str_exp") + __num(sheet.sv_str_misc)
                  sheet.sv_str_total_num = sv
                  sheet.sv_str_total = __signed(sv)

                  local t = m + __profBonus("sk_athletics_prof","sk_athletics_exp") + __num(sheet.sk_athletics_misc)
                  sheet.sk_athletics_total_num = t
                  sheet.sk_athletics_total = __signed(t)
                ]]></event>
              </dataLink>

              <!-- DEX -->
              <dataLink field="destreza">
                <event name="onChange"><![CDATA[
                  local m = __mod(sheet.destreza)
                  sheet.mod_destreza_num = m
                  sheet.mod_destreza = __signed(m)

                  local sv = m + __profBonus("sv_dex_prof","sv_dex_exp") + __num(sheet.sv_dex_misc)
                  sheet.sv_dex_total_num = sv
                  sheet.sv_dex_total = __signed(sv)

                  local t
                  t = m + __profBonus("sk_initiative_prof","sk_initiative_exp") + __num(sheet.sk_initiative_misc)
                  sheet.sk_initiative_total_num = t
                  sheet.sk_initiative_total = __signed(t)

                  t = m + __profBonus("sk_acrobatics_prof","sk_acrobatics_exp") + __num(sheet.sk_acrobatics_misc)
                  sheet.sk_acrobatics_total_num = t
                  sheet.sk_acrobatics_total = __signed(t)

                  t = m + __profBonus("sk_sleight_prof","sk_sleight_exp") + __num(sheet.sk_sleight_misc)
                  sheet.sk_sleight_total_num = t
                  sheet.sk_sleight_total = __signed(t)

                  t = m + __profBonus("sk_stealth_prof","sk_stealth_exp") + __num(sheet.sk_stealth_misc)
                  sheet.sk_stealth_total_num = t
                  sheet.sk_stealth_total = __signed(t)
                ]]></event>
              </dataLink>

              <!-- CON -->
              <dataLink field="constituicao">
                <event name="onChange"><![CDATA[
                  local m = __mod(sheet.constituicao)
                  sheet.mod_constituicao_num = m
                  sheet.mod_constituicao = __signed(m)

                  local sv = m + __profBonus("sv_con_prof","sv_con_exp") + __num(sheet.sv_con_misc)
                  sheet.sv_con_total_num = sv
                  sheet.sv_con_total = __signed(sv)
                ]]></event>
              </dataLink>

              <!-- INT -->
              <dataLink field="inteligencia">
                <event name="onChange"><![CDATA[
                  local m = __mod(sheet.inteligencia)
                  sheet.mod_inteligencia_num = m
                  sheet.mod_inteligencia = __signed(m)

                  local sv = m + __profBonus("sv_int_prof","sv_int_exp") + __num(sheet.sv_int_misc)
                  sheet.sv_int_total_num = sv
                  sheet.sv_int_total = __signed(sv)

                  local t
                  t = m + __profBonus("sk_arcana_prof","sk_arcana_exp") + __num(sheet.sk_arcana_misc)
                  sheet.sk_arcana_total_num = t
                  sheet.sk_arcana_total = __signed(t)

                  t = m + __profBonus("sk_history_prof","sk_history_exp") + __num(sheet.sk_history_misc)
                  sheet.sk_history_total_num = t
                  sheet.sk_history_total = __signed(t)

                  t = m + __profBonus("sk_investigation_prof","sk_investigation_exp") + __num(sheet.sk_investigation_misc)
                  sheet.sk_investigation_total_num = t
                  sheet.sk_investigation_total = __signed(t)

                  t = m + __profBonus("sk_nature_prof","sk_nature_exp") + __num(sheet.sk_nature_misc)
                  sheet.sk_nature_total_num = t
                  sheet.sk_nature_total = __signed(t)

                  t = m + __profBonus("sk_religion_prof","sk_religion_exp") + __num(sheet.sk_religion_misc)
                  sheet.sk_religion_total_num = t
                  sheet.sk_religion_total = __signed(t)
                ]]></event>
              </dataLink>

              <!-- WIS -->
              <dataLink field="sabedoria">
                <event name="onChange"><![CDATA[
                  local m = __mod(sheet.sabedoria)
                  sheet.mod_sabedoria_num = m
                  sheet.mod_sabedoria = __signed(m)

                  local sv = m + __profBonus("sv_wis_prof","sv_wis_exp") + __num(sheet.sv_wis_misc)
                  sheet.sv_wis_total_num = sv
                  sheet.sv_wis_total = __signed(sv)

                  local t
                  t = m + __profBonus("sk_animal_prof","sk_animal_exp") + __num(sheet.sk_animal_misc)
                  sheet.sk_animal_total_num = t
                  sheet.sk_animal_total = __signed(t)

                  t = m + __profBonus("sk_insight_prof","sk_insight_exp") + __num(sheet.sk_insight_misc)
                  sheet.sk_insight_total_num = t
                  sheet.sk_insight_total = __signed(t)

                  t = m + __profBonus("sk_medicine_prof","sk_medicine_exp") + __num(sheet.sk_medicine_misc)
                  sheet.sk_medicine_total_num = t
                  sheet.sk_medicine_total = __signed(t)

                  t = m + __profBonus("sk_perception_prof","sk_perception_exp") + __num(sheet.sk_perception_misc)
                  sheet.sk_perception_total_num = t
                  sheet.sk_perception_total = __signed(t)

                  -- Passive Perception = 10 + Perception total
                  local pp = 10 + t
                  sheet.passive_perception_num = pp
                  sheet.passive_perception = tostring(pp)

                  t = m + __profBonus("sk_survival_prof","sk_survival_exp") + __num(sheet.sk_survival_misc)
                  sheet.sk_survival_total_num = t
                  sheet.sk_survival_total = __signed(t)
                ]]></event>
              </dataLink>

              <!-- CHA -->
              <dataLink field="carisma">
                <event name="onChange"><![CDATA[
                  local m = __mod(sheet.carisma)
                  sheet.mod_carisma_num = m
                  sheet.mod_carisma = __signed(m)

                  local sv = m + __profBonus("sv_cha_prof","sv_cha_exp") + __num(sheet.sv_cha_misc)
                  sheet.sv_cha_total_num = sv
                  sheet.sv_cha_total = __signed(sv)

                  local t
                  t = m + __profBonus("sk_deception_prof","sk_deception_exp") + __num(sheet.sk_deception_misc)
                  sheet.sk_deception_total_num = t
                  sheet.sk_deception_total = __signed(t)

                  t = m + __profBonus("sk_intimidation_prof","sk_intimidation_exp") + __num(sheet.sk_intimidation_misc)
                  sheet.sk_intimidation_total_num = t
                  sheet.sk_intimidation_total = __signed(t)

                  t = m + __profBonus("sk_performance_prof","sk_performance_exp") + __num(sheet.sk_performance_misc)
                  sheet.sk_performance_total_num = t
                  sheet.sk_performance_total = __signed(t)

                  t = m + __profBonus("sk_persuasion_prof","sk_persuasion_exp") + __num(sheet.sk_persuasion_misc)
                  sheet.sk_persuasion_total_num = t
                  sheet.sk_persuasion_total = __signed(t)
                ]]></event>
              </dataLink>

              <!-- Recalc triggers: Saves -->
              <!-- Recalc triggers (RESPONSIVO): Saves -->
<dataLink field="sv_str_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sv_str_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sv_str_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sv_dex_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sv_dex_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sv_dex_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sv_con_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sv_con_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sv_con_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sv_int_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sv_int_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sv_int_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sv_wis_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sv_wis_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sv_wis_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sv_cha_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sv_cha_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sv_cha_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<!-- Recalc triggers (RESPONSIVO): Skills -->
<dataLink field="sk_initiative_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_initiative_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_initiative_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_athletics_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_athletics_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_athletics_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_acrobatics_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_acrobatics_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_acrobatics_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_sleight_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_sleight_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_sleight_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_stealth_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_stealth_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_stealth_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_arcana_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_arcana_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_arcana_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_history_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_history_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_history_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_investigation_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_investigation_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_investigation_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_nature_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_nature_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_nature_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_religion_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_religion_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_religion_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_animal_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_animal_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_animal_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_insight_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_insight_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_insight_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_medicine_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_medicine_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_medicine_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_perception_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_perception_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_perception_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_survival_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_survival_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_survival_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_deception_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_deception_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_deception_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_intimidation_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_intimidation_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_intimidation_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_performance_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_performance_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_performance_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>

<dataLink field="sk_persuasion_prof"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_persuasion_exp"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
<dataLink field="sk_persuasion_misc"><event name="onChange"><![CDATA[ recalcAll(); ]]></event></dataLink>
            </layout>
          </layout>

        </layout>
      </scrollBox>
    </tab>
<dataLink field="nome">
  <event name="onChange"><![CDATA[
    setCurrentSheet(sheet);
  ]]></event>
</dataLink>
   <!-- ===================== ABA TRAITS/EXTRAS (EMBUTIDA; SEM <frame>) ===================== -->
    <tab text="Traits / Extras">
      <scrollBox align="client">
        <layout align="top" height="1700">
          <image align="client" src="bg.png" style="autoFit"/>
          <image align="client" src="panel.png" style="autoFit"/>

          <layout align="client">
            <layout align="top" height="40">
              <label align="client" text="TRAITS / EXTRAS" fontColor="#EDEDED" fontSize="16"/>
            </layout>

            <layout align="top" height="10"/>

            <layout align="top" height="28">
              <label align="client" text="Traits" fontColor="#FFFFFF" fontSize="14"/>
            </layout>

            <layout align="top" height="300">
              <textEditor align="client" field="traits_texto" fontColor="#FFFFFF"/>
            </layout>

            <layout align="top" height="16"/>

            <layout align="top" height="28">
              <label align="client" text="Resistências / Imunidades / Vulnerabilidades" fontColor="#FFFFFF" fontSize="14"/>
            </layout>

            <layout align="top" height="240">
              <textEditor align="client" field="resist_imune_texto" fontColor="#FFFFFF"/>
            </layout>

            <layout align="top" height="16"/>

            <layout align="top" height="28">
              <label align="client" text="Idiomas / Observações" fontColor="#FFFFFF" fontSize="14"/>
            </layout>

            <layout align="top" height="240">
              <textEditor align="client" field="idiomas_obs_texto" fontColor="#FFFFFF"/>
            </layout>
          </layout>
        </layout>
      </scrollBox>
    </tab>
    <!-- ===================== ABA Ações (EMBUTIDA; SEM <frame>) ===================== -->
<tab text="Ações">
  <scrollBox align="client">
    <layout align="client">

      <!-- Título -->
      <layout align="top" height="40">
        <label align="client" text="AÇÕES" fontColor="#EDEDED" fontSize="16"/>
      </layout>

      <layout align="top" height="10"/>

      <!-- =========================
           CAIXA DE ATAQUES
           ========================= -->
      <layout align="top" height="320">
        <!-- Fundo da caixa -->
        <rectangle align="client" color="#000000" opacity="0.18" xradius="8" yradius="8"/>

        <!-- Conteúdo interno com padding "manual" -->
        <layout align="client">
          <layout align="top" height="10"/>

          <layout align="top" height="45">
            <button left="10" top="0" width="220" height="35" text="Adicionar Ataque">
              <event name="onClick"><![CDATA[
  local n = self.rclAttacks:append();
  if n ~= nil then
    n.name = n.name or "Ataque";
    n.toHit = n.toHit or "0";
    n.damage = n.damage or "1d6+0";
    n.dmgType = n.dmgType or "";
    n.notes = n.notes or "";
  else
    showMessage("Não consegui adicionar item na lista (append retornou nil).");
  end
]]></event>
            </button>
          </layout>

          <layout align="top" height="8"/>

          <!-- Cabeçalho -->
          <layout align="top" height="22">
            <label left="10" top="0" width="220" height="22" text="Nome" fontColor="#CCCCCC"/>
            <label left="240" top="0" width="70"  height="22" text="To Hit" fontColor="#CCCCCC"/>
            <label left="320" top="0" width="160" height="22" text="Dano" fontColor="#CCCCCC"/>
            <label left="490" top="0" width="120" height="22" text="Tipo" fontColor="#CCCCCC"/>
          </layout>

          <!-- Lista de ataques (ela cresce internamente; o scrollBox rola a página inteira) -->
          <recordList name="rclAttacks" field="attacks" align="client" layout="vertical">
            <layout height="92" width="9999">
              <rectangle align="client" color="#000000" opacity="0.22" xradius="6" yradius="6"/>

              <layout align="top" height="34">
                <edit  left="10"  top="6" width="220" height="24" field="name" fontColor="#FFFFFF"/>
                <edit  left="240" top="6" width="70"  height="24" field="toHit" horzTextAlign="center" fontColor="#FFFFFF"/>
                <edit  left="320" top="6" width="160" height="24" field="damage" fontColor="#FFFFFF"/>
                <edit  left="490" top="6" width="120" height="24" field="dmgType" fontColor="#FFFFFF"/>

                <button left="620" top="6" width="90" height="24" text="ROLAR">
           <event name="onClick"><![CDATA[
  local n = self:getNodeObject();
  rollAttack(n, n);
]]></event>
                </button>

                <button left="720" top="6" width="90" height="24" text="Excluir">
                <event name="onClick"><![CDATA[
  deleteAttack(self:getNodeObject());
]]></event>
                </button>
              </layout>

              <layout align="top" height="34">
                <label left="10" top="6" width="60" height="24" text="Notas:" fontColor="#CCCCCC"/>
                <edit  left="70" top="6" width="740" height="24" field="notes" fontColor="#FFFFFF"/>
              </layout>
            </layout>
          </recordList>

        </layout>
      </layout>

      <layout align="top" height="20"/>

      <!-- =========================
           AÇÕES LENDÁRIAS (mais embaixo)
           ========================= -->
      <layout align="top" height="28">
        <label align="client" text="Ações Lendárias" fontColor="#FFFFFF" fontSize="14"/>
      </layout>

      <layout align="top" height="260">
        <textEditor align="client" field="acoes_lendarias_texto" fontColor="#FFFFFF"/>
      </layout>

      <layout align="top" height="20"/>

    </layout>
  </scrollBox>
</tab>
  </tabControl>
</form>