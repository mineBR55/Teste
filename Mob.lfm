<?xml version="1.0" encoding="UTF-8"?>
<form name="frmMob"
      formType="sheetTemplate"
      dataType="br.com.mineBR55.mob"
      title="Ficha Monstro DnD 5e (Mob)">

  <script><![CDATA[
  require("firecast.lua");
  require("ndb.lua");

  local function num(v)
    local n = tonumber(v);
    return n or 0;
  end

  local function isChecked(v)
    return (v == true) or (v == "true") or (v == 1);
  end

  local function mod(score)
    return math.floor((num(score) - 10) / 2);
  end

  function buildD20(bonus)
    bonus = num(bonus);

    if bonus >= 0 then
      return "1d20 + " .. tostring(bonus);
    else
      return "1d20 - " .. tostring(math.abs(bonus));
    end
  end

  function rollBonus(title, bonus)
    if sheet == nil then return end

    local mesa = Firecast.getMesaDe(sheet);
    if mesa ~= nil and mesa.chat ~= nil then
      mesa.chat:rolarDados(Firecast.interpretarRolagem(buildD20(bonus)), title);
    end
  end

  function profBonus(profField, expField)
    if sheet == nil then return 0 end

    local pb = tonumber(sheet.prof_bonus_num) or 0;

    if isChecked(sheet[expField]) then
      if sheet[profField] ~= true then sheet[profField] = true end
      return pb * 2;
    end

    if isChecked(sheet[profField]) then return pb end
    return 0;
  end

  function resolveExpr(expr)
    expr = tostring(expr or "");
    if sheet == nil then return expr end

    local pb = tonumber(sheet.prof_bonus_num) or 0;

    local map = {
      STR = tonumber(sheet.mod_forca_num) or 0,
      DEX = tonumber(sheet.mod_destreza_num) or 0,
      CON = tonumber(sheet.mod_constituicao_num) or 0,
      INT = tonumber(sheet.mod_inteligencia_num) or 0,
      WIS = tonumber(sheet.mod_sabedoria_num) or 0,
      CHA = tonumber(sheet.mod_carisma_num) or 0,
      PB  = pb
    };

    for k, v in pairs(map) do
      expr = expr:gsub("%f[%w_]" .. k .. "%f[^%w_]", tostring(v));
    end

    return expr;
  end

  function rollExpr(title, expr)
    if sheet == nil then return end

    local mesa = Firecast.getMesaDe(sheet);
    if mesa ~= nil and mesa.chat ~= nil then
      local resolved = resolveExpr(expr);
      mesa.chat:rolarDados(Firecast.interpretarRolagem(resolved), title .. " (" .. resolved .. ")");
    end
  end

  function recalcAll()
    if sheet == nil then return end
    -- delega cálculo pesado para o Mob.lua (arquivo separado)
    if _G ~= nil and _G.recalcAll ~= nil and _G.recalcAll ~= recalcAll then
      _G.recalcAll();
      return;
    end

    -- fallback leve (se Mob.lua não carregou ainda)
    sheet.forca = sheet.forca;
    sheet.destreza = sheet.destreza;
    sheet.constituicao = sheet.constituicao;
    sheet.inteligencia = sheet.inteligencia;
    sheet.sabedoria = sheet.sabedoria;
    sheet.carisma = sheet.carisma;
    sheet.cr = sheet.cr;
  end
]]></script>

  <!-- ✅ SEM CDATA AQUI -->
  <event name="onShow">
    if recalcAll ~= nil then recalcAll(); end
  </event>

  <tabControl align="client">

    <!-- ===================== ABA FRENTE ===================== -->
    <tab text="Frente">
      <scrollBox align="client">
        <layout align="top" height="2800">

          <!-- fundo -->
          <layout align="top" height="2800">
            <image align="client" src="images/bg.png" style="autoFit"/>
            <image align="client" src="images/panel.png" style="autoFit"/>

            <layout align="client">

              <!-- ===== CAIXA: IDENTIDADE ===== -->
<layout align="top" height="160">
  <!-- fundo da caixinha -->
  <rectangle align="client" color="#100C09" opacity="0.45" xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="10"/>

    <layout align="top" height="20">
      <label left="14" top="0" width="200" height="20"
             text="IDENTIDADE" fontColor="#E7D29A" fontSize="14"/>
    </layout>

    <layout align="top" height="8"/>

    <!-- Linha 1: Nome + Tipo -->
    <layout align="top" height="30">
      <label left="14" top="6" width="60" height="20" text="Nome" fontColor="#D2BE96"/>
      <edit  left="70" top="3" width="360" height="24" field="nome" fontColor="#FFFFFF"/>

      <label left="445" top="6" width="45" height="20" text="Tipo" fontColor="#D2BE96"/>
      <edit  left="485" top="3" width="250" height="24" field="tipo" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 2: Tamanho + Alinhamento + CR + PB -->
    <layout align="top" height="30">
      <label left="14" top="6" width="70" height="20" text="Tamanho" fontColor="#D2BE96"/>
      <edit  left="80" top="3" width="140" height="24" field="tamanho" fontColor="#FFFFFF"/>

      <label left="230" top="6" width="80" height="20" text="Alinh." fontColor="#D2BE96"/>
      <edit  left="280" top="3" width="150" height="24" field="alinhamento" fontColor="#FFFFFF"/>

      <label left="440" top="6" width="30" height="20" text="CR" fontColor="#D2BE96"/>
      <edit  left="470" top="3" width="60" height="24" field="cr"
             horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="540" top="6" width="30" height="20" text="PB" fontColor="#D2BE96"/>
      <edit  left="570" top="3" width="60" height="24" field="prof_bonus"
             horzTextAlign="center" fontColor="#FFFFFF" enabled="false"/>
    </layout>

  </layout>
</layout>

<layout align="top" height="12"/>

              <!-- ===== MOVIMENTAÇÃO + SENTIDOS (LABEL EM CIMA + GRID) ===== -->
              <!-- ===== CAIXA: MOVIMENTAÇÃO ===== -->
<layout align="top" height="135">
  <rectangle align="client" color="#100C09" opacity="0.45"
             xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="10"/>

    <layout align="top" height="20">
      <label left="14" top="0" width="220" height="20"
             text="MOVIMENTAÇÃO" fontColor="#E7D29A" fontSize="14"/>
    </layout>

    <layout align="top" height="10"/>

    <!-- Linha 1 -->
    <layout align="top" height="30">
      <label left="14" top="6" width="45" height="20" text="Walk" fontColor="#D2BE96"/>
      <edit  left="58" top="3" width="60" height="24" field="mov_walk"
             horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="120" top="6" width="18" height="20" text="m" fontColor="#8E7A58"/>

      <label left="150" top="6" width="50" height="20" text="Climb" fontColor="#D2BE96"/>
      <edit  left="198" top="3" width="60" height="24" field="mov_climb"
             horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="260" top="6" width="18" height="20" text="m" fontColor="#8E7A58"/>

      <label left="290" top="6" width="35" height="20" text="Fly" fontColor="#D2BE96"/>
      <edit  left="320" top="3" width="60" height="24" field="mov_fly"
             horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="382" top="6" width="18" height="20" text="m" fontColor="#8E7A58"/>
    </layout>

    <!-- Linha 2 -->
    <layout align="top" height="30">
      <label left="14" top="6" width="45" height="20" text="Swim" fontColor="#D2BE96"/>
      <edit  left="58" top="3" width="60" height="24" field="mov_swim"
             horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="120" top="6" width="18" height="20" text="m" fontColor="#8E7A58"/>

      <label left="150" top="6" width="55" height="20" text="Burrow" fontColor="#D2BE96"/>
      <edit  left="205" top="3" width="60" height="24" field="mov_burrow"
             horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="267" top="6" width="18" height="20" text="m" fontColor="#8E7A58"/>
    </layout>

  </layout>
</layout>

<layout align="top" height="12"/>
<!-- ===== CAIXA: SENTIDOS ===== -->
<layout align="top" height="150">
  <rectangle align="client" color="#100C09" opacity="0.45"
             xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="10"/>

    <layout align="top" height="20">
      <label left="14" top="0" width="220" height="20"
             text="SENTIDOS" fontColor="#E7D29A" fontSize="14"/>
    </layout>

    <layout align="top" height="10"/>

    <!-- Linha 1 -->
    <layout align="top" height="30">
      <label left="14" top="6" width="70" text="Blindsight" fontColor="#D2BE96"/>
      <edit  left="80" top="3" width="60" height="24"
             field="sen_blind" horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="142" top="6" width="18" text="m" fontColor="#8E7A58"/>

      <label left="170" top="6" width="75" text="Darkvision" fontColor="#D2BE96"/>
      <edit  left="240" top="3" width="60" height="24"
             field="sen_dark" horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="302" top="6" width="18" text="m" fontColor="#8E7A58"/>
    </layout>

    <!-- Linha 2 -->
    <layout align="top" height="30">
      <label left="14" top="6" width="85" text="Tremorsense" fontColor="#D2BE96"/>
      <edit  left="95" top="3" width="60" height="24"
             field="sen_tremor" horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="157" top="6" width="18" text="m" fontColor="#8E7A58"/>

      <label left="185" top="6" width="70" text="Truesight" fontColor="#D2BE96"/>
      <edit  left="250" top="3" width="60" height="24"
             field="sen_true" horzTextAlign="center" fontColor="#FFFFFF"/>
      <label left="312" top="6" width="18" text="m" fontColor="#8E7A58"/>
    </layout>

    <layout align="top" height="10"/>

    <!-- Percepção Passiva -->
    <layout align="top" height="30">
      <label left="14" top="6" width="140"
             text="Percepção Passiva" fontColor="#D2BE96"/>
      <edit  left="150" top="3" width="70" height="24"
             field="percepcao_passiva"
             horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

  </layout>
</layout>

<layout align="top" height="12"/>

            <!-- ===== CAIXA: DEFESAS ===== -->
<layout align="top" height="150">
  <rectangle align="client" color="#100C09" opacity="0.45"
             xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="10"/>

    <layout align="top" height="20">
      <label left="14" top="0" width="200" height="20"
             text="DEFESAS" fontColor="#E7D29A" fontSize="14"/>
    </layout>

    <layout align="top" height="12"/>

    <!-- Linha principal -->
    <layout align="top" height="30">
      <label left="14" top="6" width="30" text="CA" fontColor="#D2BE96"/>
      <edit  left="45" top="3" width="60" height="24"
             field="ca" horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="130" top="6" width="70" text="HP Atual" fontColor="#D2BE96"/>
      <edit  left="200" top="3" width="90" height="24"
             field="hp_atual" horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="310" top="6" width="70" text="HP Máx" fontColor="#D2BE96"/>
      <edit  left="380" top="3" width="90" height="24"
             field="hp_max" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <layout align="top" height="15"/>

   <!-- Barra de Vida -->
<layout align="top" height="45">
  <label left="14" top="0" width="200" height="18"
         text="Barra de Vida" fontColor="#D2BE96"/>

  <progressBar left="14" top="20" width="520" height="18"
               field="hp_atual"
               fieldMax="hp_max"/>
</layout>
  </layout>
</layout>

<layout align="top" height="12"/>

<!-- ===== ATRIBUTOS + SAVES + SKILLS (POR ATRIBUTO) ===== -->
<layout align="top" height="12"/>

<layout align="top" height="26">
  <label align="client" text="ATRIBUTOS / SAVES / SKILLS" fontColor="#E7D29A" fontSize="14"/>
</layout>

<layout align="top" height="10"/>

<!-- ===================== FORÇA ===================== -->
<layout align="top" height="110">
  <rectangle align="client" color="#100C09" opacity="0.45" xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="8"/>

    <!-- Linha 1: atributo + save -->
    <layout align="top" height="28">
      <!-- Atributo (botão) -->
      <button left="10" top="2" width="120" height="24" text="FORÇA (STR)">
        <event name="onClick"><![CDATA[
          rollBonus("STR", sheet.mod_forca_num);
        ]]></event>
      </button>

      <label left="135" top="6" width="30" text="Val" fontColor="#A58E64"/>
      <edit  left="165" top="2" width="55" height="24" field="forca" type="number"
             horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="225" top="6" width="30" text="Mod" fontColor="#A58E64"/>
      <edit  left="255" top="2" width="55" height="24" field="mod_forca"
             readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <!-- Save (botão) -->
      <button left="325" top="2" width="80" height="24" text="Save">
        <event name="onClick"><![CDATA[
          rollBonus("STR Save", sheet.sv_str_total_num);
        ]]></event>
      </button>

      <checkBox left="410" top="6" width="18" field="sv_str_prof" text=""/>
      <checkBox left="432" top="6" width="18" field="sv_str_exp" text=""/>
      <edit     left="455" top="2" width="45" height="24" field="sv_str_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="505" top="2" width="55" height="24" field="sv_str_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 2: skill Athletics -->
    <layout align="top" height="28">
      <button left="10" top="2" width="140" height="24" text="Athletics">
        <event name="onClick"><![CDATA[
          rollBonus("Athletics", sheet.sk_athletics_total_num);
        ]]></event>
      </button>

      <checkBox left="155" top="6" width="18" field="sk_athletics_prof" text=""/>
      <checkBox left="177" top="6" width="18" field="sk_athletics_exp" text=""/>
      <edit     left="200" top="2" width="45" height="24" field="sk_athletics_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="250" top="2" width="55" height="24" field="sk_athletics_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <layout align="top" height="8"/>
  </layout>
</layout>

<layout align="top" height="10"/>

<!-- ===================== DESTREZA ===================== -->
<layout align="top" height="165">
  <rectangle align="client" color="#100C09" opacity="0.45" xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="8"/>

    <!-- Linha 1: atributo + save -->
    <layout align="top" height="28">
      <!-- Atributo (botão) -->
      <button left="10" top="2" width="140" height="24" text="DESTREZA (DEX)">
        <event name="onClick"><![CDATA[
          rollBonus("DEX", sheet.mod_destreza_num);
        ]]></event>
      </button>

      <label left="155" top="6" width="30" text="Val" fontColor="#A58E64"/>
      <edit  left="185" top="2" width="55" height="24" field="destreza" type="number"
             horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="245" top="6" width="30" text="Mod" fontColor="#A58E64"/>
      <edit  left="275" top="2" width="55" height="24" field="mod_destreza"
             readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <!-- Save (botão) -->
      <button left="345" top="2" width="80" height="24" text="Save">
        <event name="onClick"><![CDATA[
          rollBonus("DEX Save", sheet.sv_dex_total_num);
        ]]></event>
      </button>

      <checkBox left="430" top="6" width="18" field="sv_dex_prof" text=""/>
      <checkBox left="452" top="6" width="18" field="sv_dex_exp" text=""/>
      <edit     left="475" top="2" width="45" height="24" field="sv_dex_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="525" top="2" width="55" height="24" field="sv_dex_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 2: Initiative -->
    <layout align="top" height="28">
      <button left="10" top="2" width="140" height="24" text="Initiative">
        <event name="onClick"><![CDATA[
          rollBonus("Initiative", sheet.sk_initiative_total_num);
        ]]></event>
      </button>

      <checkBox left="155" top="6" width="18" field="sk_initiative_prof" text=""/>
      <checkBox left="177" top="6" width="18" field="sk_initiative_exp" text=""/>
      <edit     left="200" top="2" width="45" height="24" field="sk_initiative_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="250" top="2" width="55" height="24" field="sk_initiative_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 3: Acrobatics + Sleight of Hand -->
    <layout align="top" height="28">
      <button left="10" top="2" width="140" height="24" text="Acrobatics">
        <event name="onClick"><![CDATA[
          rollBonus("Acrobatics", sheet.sk_acrobatics_total_num);
        ]]></event>
      </button>

      <checkBox left="155" top="6" width="18" field="sk_acrobatics_prof" text=""/>
      <checkBox left="177" top="6" width="18" field="sk_acrobatics_exp" text=""/>
      <edit     left="200" top="2" width="45" height="24" field="sk_acrobatics_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="250" top="2" width="55" height="24" field="sk_acrobatics_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="325" top="2" width="170" height="24" text="Sleight of Hand">
        <event name="onClick"><![CDATA[
          rollBonus("Sleight of Hand", sheet.sk_sleight_total_num);
        ]]></event>
      </button>

      <checkBox left="500" top="6" width="18" field="sk_sleight_prof" text=""/>
      <checkBox left="522" top="6" width="18" field="sk_sleight_exp" text=""/>
      <edit     left="545" top="2" width="45" height="24" field="sk_sleight_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="595" top="2" width="55" height="24" field="sk_sleight_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 4: Stealth -->
    <layout align="top" height="28">
      <button left="10" top="2" width="140" height="24" text="Stealth">
        <event name="onClick"><![CDATA[
          rollBonus("Stealth", sheet.sk_stealth_total_num);
        ]]></event>
      </button>

      <checkBox left="155" top="6" width="18" field="sk_stealth_prof" text=""/>
      <checkBox left="177" top="6" width="18" field="sk_stealth_exp" text=""/>
      <edit     left="200" top="2" width="45" height="24" field="sk_stealth_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="250" top="2" width="55" height="24" field="sk_stealth_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <layout align="top" height="8"/>
  </layout>
</layout>

<layout align="top" height="10"/>

<!-- ===================== CONSTITUIÇÃO ===================== -->
<layout align="top" height="95">
  <rectangle align="client" color="#100C09" opacity="0.45" xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="8"/>

    <!-- Linha 1: atributo + save -->
    <layout align="top" height="28">
      <!-- Atributo (botão) -->
      <button left="10" top="2" width="170" height="24" text="CONSTITUIÇÃO (CON)">
        <event name="onClick"><![CDATA[
          rollBonus("CON", sheet.mod_constituicao_num);
        ]]></event>
      </button>

      <label left="185" top="6" width="30" text="Val" fontColor="#A58E64"/>
      <edit  left="215" top="2" width="55" height="24" field="constituicao" type="number"
             horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="275" top="6" width="30" text="Mod" fontColor="#A58E64"/>
      <edit  left="305" top="2" width="55" height="24" field="mod_constituicao"
             readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <!-- Save (botão) -->
      <button left="375" top="2" width="80" height="24" text="Save">
        <event name="onClick"><![CDATA[
          rollBonus("CON Save", sheet.sv_con_total_num);
        ]]></event>
      </button>

      <checkBox left="460" top="6" width="18" field="sv_con_prof" text=""/>
      <checkBox left="482" top="6" width="18" field="sv_con_exp" text=""/>
      <edit     left="505" top="2" width="45" height="24" field="sv_con_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="555" top="2" width="55" height="24" field="sv_con_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <layout align="top" height="8"/>
  </layout>
</layout>

<layout align="top" height="10"/>

<!-- ===================== INTELIGÊNCIA ===================== -->
<layout align="top" height="185">
  <rectangle align="client" color="#100C09" opacity="0.45" xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="8"/>

    <!-- Linha 1: atributo + save -->
    <layout align="top" height="28">
      <button left="10" top="2" width="170" height="24" text="INTELIGÊNCIA (INT)">
        <event name="onClick"><![CDATA[
          rollBonus("INT", sheet.mod_inteligencia_num);
        ]]></event>
      </button>

      <label left="185" top="6" width="30" text="Val" fontColor="#A58E64"/>
      <edit  left="215" top="2" width="55" height="24" field="inteligencia" type="number"
             horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="275" top="6" width="30" text="Mod" fontColor="#A58E64"/>
      <edit  left="305" top="2" width="55" height="24" field="mod_inteligencia"
             readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="375" top="2" width="80" height="24" text="Save">
        <event name="onClick"><![CDATA[
          rollBonus("INT Save", sheet.sv_int_total_num);
        ]]></event>
      </button>

      <checkBox left="460" top="6" width="18" field="sv_int_prof" text=""/>
      <checkBox left="482" top="6" width="18" field="sv_int_exp" text=""/>
      <edit     left="505" top="2" width="45" height="24" field="sv_int_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="555" top="2" width="55" height="24" field="sv_int_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 2: Arcana + History -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Arcana">
        <event name="onClick"><![CDATA[
          rollBonus("Arcana", sheet.sk_arcana_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_arcana_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_arcana_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_arcana_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_arcana_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="335" top="2" width="160" height="24" text="History">
        <event name="onClick"><![CDATA[
          rollBonus("History", sheet.sk_history_total_num);
        ]]></event>
      </button>
      <checkBox left="500" top="6" width="18" field="sk_history_prof" text=""/>
      <checkBox left="522" top="6" width="18" field="sk_history_exp" text=""/>
      <edit     left="545" top="2" width="45" height="24" field="sk_history_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="595" top="2" width="55" height="24" field="sk_history_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 3: Investigation + Nature -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Investigation">
        <event name="onClick"><![CDATA[
          rollBonus("Investigation", sheet.sk_investigation_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_investigation_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_investigation_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_investigation_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_investigation_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="335" top="2" width="160" height="24" text="Nature">
        <event name="onClick"><![CDATA[
          rollBonus("Nature", sheet.sk_nature_total_num);
        ]]></event>
      </button>
      <checkBox left="500" top="6" width="18" field="sk_nature_prof" text=""/>
      <checkBox left="522" top="6" width="18" field="sk_nature_exp" text=""/>
      <edit     left="545" top="2" width="45" height="24" field="sk_nature_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="595" top="2" width="55" height="24" field="sk_nature_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 4: Religion -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Religion">
        <event name="onClick"><![CDATA[
          rollBonus("Religion", sheet.sk_religion_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_religion_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_religion_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_religion_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_religion_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <layout align="top" height="8"/>
  </layout>
</layout>

<layout align="top" height="10"/>

<!-- ===================== SABEDORIA ===================== -->
<layout align="top" height="210">
  <rectangle align="client" color="#100C09" opacity="0.45" xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="8"/>

    <!-- Linha 1: atributo + save -->
    <layout align="top" height="28">
      <button left="10" top="2" width="170" height="24" text="SABEDORIA (WIS)">
        <event name="onClick"><![CDATA[
          rollBonus("WIS", sheet.mod_sabedoria_num);
        ]]></event>
      </button>

      <label left="185" top="6" width="30" text="Val" fontColor="#A58E64"/>
      <edit  left="215" top="2" width="55" height="24" field="sabedoria" type="number"
             horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="275" top="6" width="30" text="Mod" fontColor="#A58E64"/>
      <edit  left="305" top="2" width="55" height="24" field="mod_sabedoria"
             readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="375" top="2" width="80" height="24" text="Save">
        <event name="onClick"><![CDATA[
          rollBonus("WIS Save", sheet.sv_wis_total_num);
        ]]></event>
      </button>

      <checkBox left="460" top="6" width="18" field="sv_wis_prof" text=""/>
      <checkBox left="482" top="6" width="18" field="sv_wis_exp" text=""/>
      <edit     left="505" top="2" width="45" height="24" field="sv_wis_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="555" top="2" width="55" height="24" field="sv_wis_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 2: Animal Handling + Insight -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Animal Handling">
        <event name="onClick"><![CDATA[
          rollBonus("Animal Handling", sheet.sk_animal_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_animal_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_animal_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_animal_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_animal_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="335" top="2" width="160" height="24" text="Insight">
        <event name="onClick"><![CDATA[
          rollBonus("Insight", sheet.sk_insight_total_num);
        ]]></event>
      </button>
      <checkBox left="500" top="6" width="18" field="sk_insight_prof" text=""/>
      <checkBox left="522" top="6" width="18" field="sk_insight_exp" text=""/>
      <edit     left="545" top="2" width="45" height="24" field="sk_insight_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="595" top="2" width="55" height="24" field="sk_insight_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 3: Medicine + Perception -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Medicine">
        <event name="onClick"><![CDATA[
          rollBonus("Medicine", sheet.sk_medicine_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_medicine_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_medicine_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_medicine_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_medicine_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="335" top="2" width="160" height="24" text="Perception">
        <event name="onClick"><![CDATA[
          rollBonus("Perception", sheet.sk_perception_total_num);
        ]]></event>
      </button>
      <checkBox left="500" top="6" width="18" field="sk_perception_prof" text=""/>
      <checkBox left="522" top="6" width="18" field="sk_perception_exp" text=""/>
      <edit     left="545" top="2" width="45" height="24" field="sk_perception_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="595" top="2" width="55" height="24" field="sk_perception_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 4: Survival -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Survival">
        <event name="onClick"><![CDATA[
          rollBonus("Survival", sheet.sk_survival_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_survival_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_survival_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_survival_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_survival_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <layout align="top" height="8"/>
  </layout>
</layout>

<layout align="top" height="10"/>

<!-- ===================== CARISMA ===================== -->
<layout align="top" height="185">
  <rectangle align="client" color="#100C09" opacity="0.45" xradius="10" yradius="10" enabled="false"/>

  <layout align="client">
    <layout align="top" height="8"/>

    <!-- Linha 1: atributo + save -->
    <layout align="top" height="28">
      <button left="10" top="2" width="170" height="24" text="CARISMA (CHA)">
        <event name="onClick"><![CDATA[
          rollBonus("CHA", sheet.mod_carisma_num);
        ]]></event>
      </button>

      <label left="185" top="6" width="30" text="Val" fontColor="#A58E64"/>
      <edit  left="215" top="2" width="55" height="24" field="carisma" type="number"
             horzTextAlign="center" fontColor="#FFFFFF"/>

      <label left="275" top="6" width="30" text="Mod" fontColor="#A58E64"/>
      <edit  left="305" top="2" width="55" height="24" field="mod_carisma"
             readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="375" top="2" width="80" height="24" text="Save">
        <event name="onClick"><![CDATA[
          rollBonus("CHA Save", sheet.sv_cha_total_num);
        ]]></event>
      </button>

      <checkBox left="460" top="6" width="18" field="sv_cha_prof" text=""/>
      <checkBox left="482" top="6" width="18" field="sv_cha_exp" text=""/>
      <edit     left="505" top="2" width="45" height="24" field="sv_cha_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="555" top="2" width="55" height="24" field="sv_cha_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 2: Deception + Intimidation -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Deception">
        <event name="onClick"><![CDATA[
          rollBonus("Deception", sheet.sk_deception_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_deception_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_deception_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_deception_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_deception_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="335" top="2" width="160" height="24" text="Intimidation">
        <event name="onClick"><![CDATA[
          rollBonus("Intimidation", sheet.sk_intimidation_total_num);
        ]]></event>
      </button>
      <checkBox left="500" top="6" width="18" field="sk_intimidation_prof" text=""/>
      <checkBox left="522" top="6" width="18" field="sk_intimidation_exp" text=""/>
      <edit     left="545" top="2" width="45" height="24" field="sk_intimidation_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="595" top="2" width="55" height="24" field="sk_intimidation_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <!-- Linha 3: Performance + Persuasion -->
    <layout align="top" height="28">
      <button left="10" top="2" width="160" height="24" text="Performance">
        <event name="onClick"><![CDATA[
          rollBonus("Performance", sheet.sk_performance_total_num);
        ]]></event>
      </button>
      <checkBox left="175" top="6" width="18" field="sk_performance_prof" text=""/>
      <checkBox left="197" top="6" width="18" field="sk_performance_exp" text=""/>
      <edit     left="220" top="2" width="45" height="24" field="sk_performance_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="270" top="2" width="55" height="24" field="sk_performance_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>

      <button left="335" top="2" width="160" height="24" text="Persuasion">
        <event name="onClick"><![CDATA[
          rollBonus("Persuasion", sheet.sk_persuasion_total_num);
        ]]></event>
      </button>
      <checkBox left="500" top="6" width="18" field="sk_persuasion_prof" text=""/>
      <checkBox left="522" top="6" width="18" field="sk_persuasion_exp" text=""/>
      <edit     left="545" top="2" width="45" height="24" field="sk_persuasion_misc" type="number"
                horzTextAlign="center" fontColor="#FFFFFF"/>
      <edit     left="595" top="2" width="55" height="24" field="sk_persuasion_total"
                readOnly="true" horzTextAlign="center" fontColor="#FFFFFF"/>
    </layout>

    <layout align="top" height="8"/>
  </layout>
</layout>

<layout align="top" height="10"/>
              
              <!-- ===================== CÁLCULOS ===================== -->

              <!-- CR -> PB (tabela oficial 5e) -->
<!-- ===================== CÁLCULOS ===================== -->

<!-- Recalc ao mudar CR -->
<dataLink field="cr">
  <event name="onChange"><![CDATA[
    if recalcAll ~= nil then recalcAll(); end
  ]]></event>
</dataLink>

<!-- Recalc ao mudar atributos base -->
<dataLink field="forca"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="destreza"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="constituicao"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="inteligencia"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sabedoria"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="carisma"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<!-- ===================== Recalc triggers: SAVES ===================== -->
<dataLink field="sv_str_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sv_str_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sv_str_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sv_dex_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sv_dex_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sv_dex_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sv_con_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sv_con_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sv_con_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sv_int_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sv_int_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sv_int_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sv_wis_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sv_wis_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sv_wis_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sv_cha_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sv_cha_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sv_cha_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<!-- ===================== Recalc triggers: SKILLS ===================== -->
<dataLink field="sk_initiative_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_initiative_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_initiative_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_athletics_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_athletics_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_athletics_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_acrobatics_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_acrobatics_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_acrobatics_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_sleight_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_sleight_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_sleight_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_stealth_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_stealth_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_stealth_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_arcana_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_arcana_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_arcana_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_history_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_history_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_history_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_investigation_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_investigation_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_investigation_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_nature_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_nature_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_nature_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_religion_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_religion_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_religion_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_animal_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_animal_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_animal_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_insight_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_insight_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_insight_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_medicine_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_medicine_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_medicine_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_perception_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_perception_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_perception_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_survival_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_survival_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_survival_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_deception_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_deception_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_deception_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_intimidation_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_intimidation_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_intimidation_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_performance_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_performance_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_performance_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>

<dataLink field="sk_persuasion_prof"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_persuasion_exp"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
<dataLink field="sk_persuasion_misc"><event name="onChange"><![CDATA[ if recalcAll ~= nil then recalcAll(); end ]]></event></dataLink>
            </layout>
          </layout>

        </layout>
      </scrollBox>
    </tab>
   <!-- ===================== ABA TRAITS/EXTRAS (EMBUTIDA; SEM <frame>) ===================== -->
    <tab text="Traits / Extras">
      <scrollBox align="client">
        <layout align="top" height="1850">
          <image align="client" src="images/bg.png" style="autoFit"/>
          <image align="client" src="images/panel.png" style="autoFit"/>

          <layout align="client">
            <layout align="top" height="44">
              <rectangle left="0" top="40" width="9999" height="1" color="#6F5730" opacity="0.55" enabled="false"/>
              <label align="client" text="TRAITS / EXTRAS" fontColor="#E7D29A" fontSize="16"/>
            </layout>

            <layout align="top" height="10"/>

            <layout align="top" height="360">
              <rectangle align="client" color="#100C09" opacity="0.45" xradius="10" yradius="10" enabled="false"/>
              <layout align="client">
                <layout align="top" height="10"/>
                <layout align="top" height="24">
                  <label left="12" top="2" width="300" text="TRAITS" fontColor="#E7D29A" fontSize="14"/>
                </layout>
                <layout align="top" height="2"><rectangle left="12" top="0" width="320" height="1" color="#6F5730" opacity="0.60" enabled="false"/></layout>
                <layout align="top" height="6"/>
                <layout align="client">
                  <textEditor align="client" field="traits_texto" fontColor="#FFFFFF"/>
                </layout>
                <layout align="top" height="10"/>
              </layout>
            </layout>

            <layout align="top" height="16"/>

            <layout align="top" height="300">
              <rectangle align="client" color="#100C09" opacity="0.45" xradius="10" yradius="10" enabled="false"/>
              <layout align="client">
                <layout align="top" height="10"/>
                <layout align="top" height="24">
                  <label left="12" top="2" width="500" text="RESISTÊNCIAS / IMUNIDADES / VULNERABILIDADES" fontColor="#E7D29A" fontSize="13"/>
                </layout>
                <layout align="top" height="6"/>
                <layout align="client">
                  <textEditor align="client" field="resist_imune_texto" fontColor="#FFFFFF"/>
                </layout>
                <layout align="top" height="10"/>
              </layout>
            </layout>

            <layout align="top" height="16"/>

            <layout align="top" height="300">
              <rectangle align="client" color="#100C09" opacity="0.45" xradius="10" yradius="10" enabled="false"/>
              <layout align="client">
                <layout align="top" height="10"/>
                <layout align="top" height="24">
                  <label left="12" top="2" width="350" text="IDIOMAS / OBSERVAÇÕES" fontColor="#E7D29A" fontSize="13"/>
                </layout>
                <layout align="top" height="6"/>
                <layout align="client">
                  <textEditor align="client" field="idiomas_obs_texto" fontColor="#FFFFFF"/>
                </layout>
                <layout align="top" height="10"/>
              </layout>
            </layout>
          </layout>
        </layout>
      </scrollBox>
    </tab>
    <!-- ===================== ABA Ações (EMBUTIDA; SEM <frame>) ===================== -->
<tab text="Ações">
  <scrollBox align="client">
    <layout align="top" height="1100">
      <image align="client" src="images/bg.png" style="autoFit"/>
      <image align="client" src="images/panel.png" style="autoFit"/>

      <layout align="client">

        <layout align="top" height="40">
          <label align="client" text="AÇÕES" fontColor="#E7D29A" fontSize="16"/>
        </layout>

        <layout align="top" height="10"/>

        <layout align="top" height="340">
          <rectangle align="client" color="#100C09" opacity="0.45" xradius="10" yradius="10" enabled="false"/>

          <layout align="client">
            <layout align="top" height="10"/>

            <layout align="top" height="24">
              <label left="12" top="2" width="250" text="ATAQUES" fontColor="#E7D29A" fontSize="14"/>
            </layout>
            <layout align="top" height="2"><rectangle left="12" top="0" width="260" height="1" color="#6F5730" opacity="0.60" enabled="false"/></layout>

            <layout align="top" height="8"/>

            <layout align="top" height="45">
              <button left="10" top="0" width="220" height="35" text="Novo Ataque">
                <event name="onClick"><![CDATA[
  local form = self;
  for i = 1, 20 do
    if form == nil then break; end
    if form.rclAttacks ~= nil then break; end
    form = form.parent;
  end;

  local lista = nil;
  if form ~= nil then lista = form.rclAttacks; end

  if lista == nil then
    showMessage("Não consegui localizar a lista de ataques (rclAttacks).");
    return;
  end

  local n = lista:append();
  if n ~= nil then
    n.name = n.name or "Ataque";
    n.toHit = n.toHit or "0";
    n.damage = n.damage or "1d6+0";
    n.dmgType = n.dmgType or "";
    n.notes = n.notes or "";
  else
    showMessage("Não consegui adicionar item na lista (append retornou nil).");
  end
]]></event>
              </button>
            </layout>

            <layout align="top" height="8"/>

            <layout align="top" height="22">
              <label left="10" top="0" width="220" height="22" text="Nome" fontColor="#D2BE96"/>
              <label left="240" top="0" width="70"  height="22" text="To Hit" fontColor="#D2BE96"/>
              <label left="320" top="0" width="160" height="22" text="Dano" fontColor="#D2BE96"/>
              <label left="490" top="0" width="120" height="22" text="Tipo" fontColor="#D2BE96"/>
            </layout>

            <recordList name="rclAttacks" field="attacks" align="client" layout="vertical">
              <layout height="92" width="9999">
                <rectangle align="client" color="#0F0C0A" opacity="0.42" xradius="6" yradius="6" enabled="false"/>

                <layout align="top" height="34">
                  <edit  left="10"  top="6" width="220" height="24" field="name" fontColor="#FFFFFF"/>
                  <edit  left="240" top="6" width="70"  height="24" field="toHit" horzTextAlign="center" fontColor="#FFFFFF"/>
                  <edit  left="320" top="6" width="160" height="24" field="damage" fontColor="#FFFFFF"/>
                  <edit  left="490" top="6" width="120" height="24" field="dmgType" fontColor="#FFFFFF"/>

                  <button left="620" top="6" width="90" height="24" text="Rolar">
                    <event name="onClick"><![CDATA[
  local n = self:getNodeObject();
  if n == nil then
    showMessage("Nenhum ataque selecionado.");
    return;
  end
  rollAttack(n, n);
]]></event>
                  </button>

                  <button left="720" top="6" width="90" height="24" text="Apagar">
                    <event name="onClick"><![CDATA[
  local n = self:getNodeObject();
  if n ~= nil then deleteAttack(n); end
]]></event>
                  </button>
                </layout>

                <layout align="top" height="34">
                  <label left="10" top="6" width="60" height="24" text="Notas:" fontColor="#D2BE96"/>
                  <edit  left="70" top="6" width="740" height="24" field="notes" fontColor="#FFFFFF"/>
                </layout>
              </layout>
            </recordList>
          </layout>
        </layout>

        <layout align="top" height="20"/>

        <layout align="top" height="330">
          <rectangle align="client" color="#100C09" opacity="0.45" xradius="10" yradius="10" enabled="false"/>

          <layout align="client">
            <layout align="top" height="10"/>
            <layout align="top" height="24">
              <label left="12" top="2" width="260" text="AÇÕES LENDÁRIAS" fontColor="#E7D29A" fontSize="14"/>
            </layout>
            <layout align="top" height="6"/>
            <layout align="client">
              <textEditor align="client" field="acoes_lendarias_texto" fontColor="#FFFFFF"/>
            </layout>
            <layout align="top" height="10"/>
          </layout>
        </layout>

        <layout align="top" height="20"/>

      </layout>
    </layout>
  </scrollBox>
</tab>
  </tabControl>
</form>